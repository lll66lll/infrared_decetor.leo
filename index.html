<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>红外偷拍检测工具</title><script async src="https://docs.opencv.org/4.8.0/opencv.js"></script><style>*{margin:0;padding:0;box-sizing:border-box}body{width:100vw;height:100vh;overflow:hidden;background:#000}#video{width:100%;height:100%;object-fit:cover}#canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}.control{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);display:flex;gap:20px}.btn{padding:12px 24px;border:none;border-radius:8px;background:#28a745;color:#fff;font-size:16px;cursor:pointer}.btn.active{background:#dc3545}#tip{position:absolute;top:20px;left:50%;transform:translateX(-50%);color:#fff;font-size:16px;text-shadow:0 0 5px #000;max-width:80%;text-align:center}#debug{position:absolute;top:60px;left:50%;transform:translateX(-50%);color:#ff9900;font-size:14px;text-shadow:0 0 5px #000;max-width:80%;text-align:center}</style></head><body><video id="video" autoplay playsinline muted></video><canvas id="canvas"></canvas><div id="tip">初始化中...请稍等</div><div id="debug">调试信息：未加载</div><div class="control"><button class="btn" id="modeBtn">切换为精确模式</button><button class="btn" id="startBtn">开始检测</button></div><script>const video=document.getElementById("video"),canvas=document.getElementById("canvas"),ctx=canvas.getContext("2d"),modeBtn=document.getElementById("modeBtn"),startBtn=document.getElementById("startBtn"),tip=document.getElementById("tip"),debug=document.getElementById("debug");let isDetecting=!1,isPreciseMode=!1,cvLoaded=!1;debug.textContent="调试信息：等待OpenCV加载";cv.onRuntimeInitialized=()=>{cvLoaded=!0,tip.textContent="算法就绪，准备调用摄像头",debug.textContent="调试信息：OpenCV加载成功";// 立即尝试调用摄像头
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(e=>{video.srcObject=e,debug.textContent="调试信息：摄像头调用成功（后置）";video.onplay=()=>{canvas.width=video.videoWidth,canvas.height=video.videoHeight,tip.textContent="点击开始检测，支持双模式切换",debug.textContent="调试信息：视频流已就绪"}}).catch(e=>{debug.textContent="调试信息：摄像头调用失败 → "+errMsg(e);tip.textContent="摄像头调用失败，看下方调试信息",console.error(e)})};// 摄像头错误码解析
function errMsg(e){switch(e.name){case"NotAllowedError":return"权限被拒绝（去浏览器设置开相机权限）";case"NotFoundError":return"未找到摄像头（后置摄像头故障/被遮挡）";case"NotReadableError":return"摄像头被占用（关闭微信/相机APP）";case"SecurityError":return"非HTTPS链接（检查GitHub Pages配置）";default:return"未知错误："+e.message}};modeBtn.addEventListener("click",()=>{isPreciseMode=!isPreciseMode,modeBtn.textContent=isPreciseMode?"切换为大致方向":"切换为精确模式",tip.textContent=isPreciseMode?"精确模式：十字准星标记光点":"大致方向：箭头标注区域"});startBtn.addEventListener("click",()=>{if(!cvLoaded){tip.textContent="算法还没加载完，再等2秒";return}if(!video.srcObject){tip.textContent="摄像头没调用成功，看调试信息";return}isDetecting=!isDetecting,startBtn.classList.toggle("active"),startBtn.textContent=isDetecting?"停止检测":"开始检测",isDetecting&&detectLoop()});function detectLoop(){if(!isDetecting||!cvLoaded)return;const e=new cv.Mat(video.videoHeight,video.videoWidth,cv.CV_8UC4),t=new cv.Mat(video.videoHeight,video.videoWidth,cv.CV_8UC4),i=new cv.VideoCapture(video);i.read(e),cv.cvtColor(e,t,cv.COLOR_RGBA2GRAY);const o=new cv.Mat;cv.threshold(t,o,200,255,cv.THRESH_BINARY);const d=cv.getStructuringElement(cv.MORPH_ELLIPSE,new cv.Size(5,5));cv.morphologyEx(o,o,cv.MORPH_OPEN,d);const r=new cv.MatVector,a=new cv.Mat;cv.findContours(o,r,a,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE),ctx.clearRect(0,0,canvas.width,canvas.height);for(let e=0;e<r.size();e++){const t=r.get(e),[i,o,d]=cv.minEnclosingCircle(t);if(d>3)if(isPreciseMode){drawCross(i,o,"#ff0000",2);const e=getDistance(d);ctx.fillStyle="#ff0000",ctx.font="16px sans-serif",ctx.fillText(`距离: ${e}m`,i+20,o-10)}else{drawArrow(i,o,"#00ff00",2);const e=getDirection(i,o);ctx.fillStyle="#00ff00",ctx.font="16px sans-serif",ctx.fillText(`方向: ${e}`,i+20,o-10)}t.delete()}e.delete(),t.delete(),o.delete(),d.delete(),r.delete(),a.delete(),requestAnimationFrame(detectLoop)}function drawCross(e,t,i,o){ctx.strokeStyle=i,ctx.lineWidth=o,ctx.beginPath(),ctx.moveTo(e-15,t),ctx.lineTo(e+15,t),ctx.moveTo(e,t-15),ctx.lineTo(e,t+15),ctx.stroke()}function drawArrow(e,t,i,o){ctx.strokeStyle=i,ctx.lineWidth=o,ctx.beginPath(),ctx.moveTo(canvas.width/2,canvas.height/2),ctx.lineTo(e,t),ctx.lineCap="round",ctx.stroke()}function getDistance(e){return e>15?"0.5以内":e>8?"0.5-1.0":e>4?"1.0-1.5":"1.5-2.0"}function getDirection(e,t){const i=canvas.width/2,o=canvas.height/2;return e<i*.6&&t<o*.6?"左上区域":e>i*1.4&&t<o*.6?"右上区域":e<i*.6&&t>o*1.4?"左下区域":e>i*1.4&&t>o*1.4?"右下区域":e<i*.6?"左侧区域":e>i*1.4?"右侧区域":t<o*.6?"上方区域":t>o*1.4?"下方区域":"前方区域"}</script></body></html>